<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="it">

<head>
    <meta charset="utf-8">
    <title th:text="${product.name}">Dettaglio prodotto</title>

    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/product-detail.css}">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="pd-page">
    <!-- in alto al body della pagina -->
    <span id="close"></span>


    <div th:replace="~{fragments/header :: siteHeader}"></div>

    <main class="pd pd--alt">
        <!-- BACK top-right -->
        <a class="pd-back" th:href="@{/products}">← Indietro</a>

        <!-- HERO -->
        <section class="pd-hero">
            <!-- Colonna SX: info -->
            <div class="pd-info">
                <h1 class="pd-title" th:text="${product.name}">Nome prodotto</h1>
                <div class="pd-price">
                    <span th:text="${#numbers.formatDecimal(product.price,1,2)}">0,00</span> €
                </div>

                <div class="pd-actions" style="display:flex; gap:10px; margin-top:6px;">
                    <!-- bottone “whitelabel” accentato -->
                    <a class="btn-wl btn-wl--accent" th:href="@{|/reviews/new?productId=${product.id}|}">
                        Recensisci prodotto
                    </a>
                    <!-- esempio di whitelabel neutro riutilizzabile -->
                    <a class="btn-wl" th:href="@{/products}">Torna al catalogo</a>
                </div>
            </div>

            <!-- Colonna DX: media -->
            <aside class="pd-media">
                <img class="pd-img"
                    th:src="${#strings.isEmpty(product.imageUrl)} ? @{/img/placeholder.png} : ${product.imageUrl}"
                    th:alt="${product.name}" onerror="this.onerror=null;this.src='/img/placeholder.png';">
            </aside>
        </section>

        <!-- SEZIONI SOTTO -->
        <section class="pd-sections">
            <article class="pd-card">
                <h2>Dettagli prodotto</h2>
                <div class="pd-desc"
                    th:utext="${#strings.isEmpty(product.description) ? 'Nessuna descrizione disponibile.' : product.description}">
                    Testo descrizione…
                </div>
            </article>

            <article class="pd-card">
                <h2>Recensioni</h2>

                <!-- messaggi flash -->
                <div class="alert alert-success" th:if="${ok}" th:text="${ok}"></div>
                <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>

                <div class="pd-reviews" th:if="${reviews != null and !#lists.isEmpty(reviews)}">
                    <div class="pd-review" th:each="r : ${reviews}">
                        <!-- Intestazione: stelle statiche + autore + data -->
                        <div class="d-flex align-items-center gap-3">
                            <span class="stars">
                                <span th:each="i: ${#numbers.sequence(1,5)}"
                                    th:text="${i <= r.stars} ? '★' : '☆'">★</span>
                            </span>
                            <span class="who"
                                th:text="${r.author != null ? r.author.email : 'Utente'}">utente@example.com</span>
                            <span class="when"
                                th:text="${#temporals.format(r.createdAt, 'dd/MM/yyyy')}">25/09/2025</span>
                        </div>

                        <!-- Testo recensione -->
                        <p class="txt mt-1 mb-2" th:text="${r.content}">Testo recensione…</p>

                        <!-- Azioni SOLO del proprietario (link che aprono pannelli via :target) -->
                        <div class="mt-2" th:if="${meId != null and r.author != null and r.author.id == meId}">
                            <a class="btn btn-sm btn-outline-primary" th:href="${'#edit-' + r.id}">Modifica</a>
                            <a class="btn btn-sm btn-outline-danger" th:href="${'#del-' + r.id}">Elimina</a>
                        </div>

                        <!-- PANEL MODIFICA (nascosto, si apre con #edit-{id}) -->
                        <div th:id="${'edit-' + r.id}" class="panel edit-panel">
                            <form th:action="@{'/reviews/' + ${r.id} + '/update'}" method="post" class="vstack gap-2">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                <!-- stelle editabili (solo HTML/CSS) -->
                                <div class="rating">
                                    <input th:id="${'s5-' + r.id}" type="radio" name="stars" value="5"
                                        th:checked="${r.stars == 5}">
                                    <label th:for="${'s5-' + r.id}"></label>
                                    <input th:id="${'s4-' + r.id}" type="radio" name="stars" value="4"
                                        th:checked="${r.stars == 4}">
                                    <label th:for="${'s4-' + r.id}"></label>
                                    <input th:id="${'s3-' + r.id}" type="radio" name="stars" value="3"
                                        th:checked="${r.stars == 3}">
                                    <label th:for="${'s3-' + r.id}"></label>
                                    <input th:id="${'s2-' + r.id}" type="radio" name="stars" value="2"
                                        th:checked="${r.stars == 2}">
                                    <label th:for="${'s2-' + r.id}"></label>
                                    <input th:id="${'s1-' + r.id}" type="radio" name="stars" value="1"
                                        th:checked="${r.stars == 1}">
                                    <label th:for="${'s1-' + r.id}"></label>
                                </div>

                                <textarea name="content" rows="2" class="form-control" maxlength="2000"
                                    th:text="${r.content}"></textarea>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-sm btn-primary">Salva</button>
                                    <!-- chiudi il pannello tornando a #close -->
                                    <a class="btn btn-sm btn-light" href="#close">Annulla</a>
                                </div>
                            </form>
                        </div>

                        <!-- PANEL CONFERMA ELIMINAZIONE (nascosto, si apre con #del-{id}) -->
                        <div th:id="${'del-' + r.id}" class="panel confirm-panel">
                            <div class="confirm-box">
                                <p class="mb-2">Sicuro di voler eliminare questo commento?</p>
                                <form th:action="@{'/reviews/' + ${r.id} + '/delete'}" method="post"
                                    class="d-inline-block">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-sm btn-danger">Conferma</button>
                                </form>
                                <a class="btn btn-sm btn-light ms-2" href="#close">Annulla</a>
                            </div>
                        </div>

                        <hr class="my-3" />
                    </div>
                </div>

                <p th:if="${reviews == null or #lists.isEmpty(reviews)}">Ancora nessuna recensione.</p>



            </article>
        </section>

        <!-- (facoltativo) sezione prodotti simili: puoi riusare il fragment del catalogo -->
        <!-- <section class="pd-sections">
      <article class="pd-card">
        <h2>Prodotti simili</h2>
        <div th:replace="~{catalog-cards :: productGrid(${simili})}"></div>
      </article>
    </section> -->
    </main>
</body>

</html>